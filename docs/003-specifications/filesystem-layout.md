# GHWT ファイルシステムレイアウト仕様書

**Date**: 2025-06-01  
Version 1.0 — 2025-06-01

## このドキュメントの役割

- **対象読者**: 開発者、実装担当者
- **目的**: Nick Nisi式アプローチの技術的実装詳細を定義
- **含む内容**: ディレクトリ構造、パス解決ルール、gitfile仕様、安全性機構
- **他ドキュメントとの関係**: 要件定義書で概要が示された技術方針の具体的実装仕様

## 概要

本ドキュメントは GHWT (Git Worktree Tool) のファイルシステムレイアウトとディレクトリ規約の完全仕様書である。
Nick Nisi式アプローチに基づく「1 Repository = 1 Directory」原則の具体的実装方法を定義し、
bare repository + worktree レイアウトの詳細仕様を明確化する。

## 関連ドキュメント

- [../002-requirements/requirements-ja.md](../002-requirements/requirements-ja.md) - 基本要件
- [../001-adr/003-directory-principle.md](../001-adr/003-directory-principle.md) - ディレクトリ原則
- [cli-interface.md](cli-interface.md) - CLI インターフェース仕様

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-06-01 | 1.0 | 初版作成 |

---

## 1. ディレクトリ構造の完全定義

### 1.1 基本レイアウト

GHWT は以下の構造化されたディレクトリレイアウトを採用する：

```
~/ghwt/<repo>/
├── .bare/              # bare repository (git clone --bare の内容)
│   ├── HEAD
│   ├── config
│   ├── description
│   ├── hooks/
│   ├── info/
│   ├── objects/
│   ├── refs/
│   │   ├── heads/
│   │   ├── remotes/
│   │   └── tags/
│   └── packed-refs
├── .git                # gitfile (gitdir: ./.bare)
└── .wt/                # worktree 専用ディレクトリ
    ├── main/           # メインブランチ worktree
    ├── feature-auth/   # フィーチャーブランチ worktree
    ├── hotfix-123/     # ホットフィックス worktree
    └── develop/        # 開発ブランチ worktree
```

### 1.2 ディレクトリ詳細仕様

#### 1.2.1 `.bare/` ディレクトリ
- **目的**: Git データベースの格納
- **内容**: `git clone --bare` で取得したリポジトリの完全なコピー
- **権限**: 755 (ディレクトリ), 644 (ファイル)
- **特徴**: 
  - 作業ディレクトリを持たない純粋な Git データベース
  - 全ブランチ・タグ・履歴情報を含む
  - 複数の worktree から共有される

#### 1.2.2 `.git` ファイル (gitfile)
- **目的**: bare repository への参照
- **内容**: `gitdir: ./.bare`
- **権限**: 644
- **形式**: プレーンテキスト、改行なし

#### 1.2.3 `.wt/` ディレクトリ
- **目的**: 全 worktree の格納
- **権限**: 755
- **命名規則**: ブランチ名をファイルシステム安全な形式に正規化
- **特徴**:
  - 各サブディレクトリが独立した作業ディレクトリ
  - ブランチごとに完全に分離された環境
  - 並行作業・ビルド・テストが可能

---

## 2. パス解決ルール

### 2.1 基本パス構成

| パス種別 | 形式 | 例 |
|----------|------|-----|
| **GHWT root** | `$GHQ_ROOT` または `~/ghwt` | `~/ghwt` |
| **Repository path** | `<GHWT_ROOT>/<repo_name>/` | `~/ghwt/myrepo/` |
| **Bare repository** | `<repo_path>/.bare/` | `~/ghwt/myrepo/.bare/` |
| **Worktree path** | `<repo_path>/.wt/<branch>/` | `~/ghwt/myrepo/.wt/main/` |

### 2.2 GHWT Root 決定アルゴリズム

```
1. 環境変数 $GHQ_ROOT が設定されている場合
   → $GHQ_ROOT を使用

2. $GHQ_ROOT が未設定の場合
   → ~/ghwt を使用

3. 指定されたパスが存在しない場合
   → 自動作成 (権限: 755)
```

### 2.3 リポジトリ名正規化ルール

Git URL からリポジトリ名を抽出する際の正規化ルール：

| 入力 URL | 抽出されるリポジトリ名 |
|----------|----------------------|
| `git@github.com:user/repo.git` | `repo` |
| `https://github.com/user/repo.git` | `repo` |
| `https://github.com/user/repo` | `repo` |
| `git@gitlab.com:group/subgroup/project.git` | `project` |
| `file:///path/to/repo.git` | `repo` |

**正規化アルゴリズム:**
```
1. URL の最後のパス要素を取得
2. .git 拡張子を除去
3. ファイルシステム安全な文字のみ保持 ([a-zA-Z0-9_-])
4. 先頭・末尾の特殊文字を除去
```

### 2.4 ブランチ名正規化ルール

ブランチ名をファイルシステム安全な形式に変換：

| 元のブランチ名 | 正規化後 |
|---------------|----------|
| `feature/user-auth` | `feature-user-auth` |
| `hotfix/issue-123` | `hotfix-issue-123` |
| `release/v1.2.3` | `release-v1.2.3` |
| `user@domain/feature` | `user-domain-feature` |

**正規化アルゴリズム:**
```
1. スラッシュ (/) をハイフン (-) に変換
2. アットマーク (@) をハイフン (-) に変換
3. ファイルシステム安全でない文字を除去
4. 連続するハイフンを単一のハイフンに統合
5. 先頭・末尾のハイフンを除去
```

---

## 3. gitfile 仕様

### 3.1 gitfile の内容

```
gitdir: ./.bare
```

### 3.2 gitfile 作成仕様

| 項目 | 仕様 |
|------|------|
| **ファイル名** | `.git` |
| **内容** | `gitdir: ./.bare` (改行なし) |
| **文字エンコーディング** | UTF-8 |
| **権限** | 644 |
| **所有者** | 実行ユーザー |

### 3.3 gitfile 検証ルール

gitfile の妥当性を検証する条件：

1. **存在確認**: `.git` ファイルが存在する
2. **内容確認**: `gitdir: ./.bare` の文字列が含まれる
3. **参照先確認**: `.bare` ディレクトリが存在し、有効な Git リポジトリである
4. **権限確認**: 読み取り可能な権限が設定されている

---

## 4. ディレクトリ作成・削除の安全性

### 4.1 作成時の安全性保証

#### 4.1.1 権限設定
| 対象 | 権限 | 理由 |
|------|------|------|
| ディレクトリ | 755 | 所有者: 読み書き実行, その他: 読み実行 |
| ファイル | 644 | 所有者: 読み書き, その他: 読み取りのみ |

#### 4.1.2 途中で失敗しない安全な作成

**背景**: リポジトリ作成中にネットワークエラーや容量不足が発生すると、中途半端な状態のディレクトリが残ってしまう問題があります。これにより次回の作成時にエラーが発生したり、手動でのクリーンアップが必要になります。

**解決方法**:
```
1. 一時ディレクトリでの構築
   ~/ghwt/.tmp/<repo>-<timestamp>/

2. 完全な構築後に最終位置へ移動
   mv ~/ghwt/.tmp/<repo>-<timestamp>/ ~/ghwt/<repo>/

3. 失敗時の自動クリーンアップ
   rm -rf ~/ghwt/.tmp/<repo>-<timestamp>/
```

**ディレクトリ管理**:
- **`.tmp/` ディレクトリ**: 初回使用時に `~/ghwt/.tmp/` を自動作成
- **一時ディレクトリ**: 各操作開始時に `<repo>-<timestamp>/` を作成
- **自動削除**: 成功時は移動により自動削除、失敗時は明示的に削除

**目的**: 作成途中でエラーが発生しても、中途半端な状態のディレクトリが残らないようにする

#### 4.1.3 並行操作の競合回避

**背景**: 複数のGHWTコマンドを同時に実行した場合、同じリポジトリに対して同時にディレクトリ作成や削除が行われると、ファイルシステムの競合状態が発生し、データ破損や予期しないエラーが起こる可能性があります。

**解決方法**:
```
1. ロックファイルの作成
   ~/ghwt/.lock/<repo>.lock

2. 操作完了後のロック解除
   rm ~/ghwt/.lock/<repo>.lock

3. ロックタイムアウト (デフォルト: 30秒)
   古いロックファイルの自動削除
```

**ロック管理**:
- **`.lock/` ディレクトリ**: 初回使用時に `~/ghwt/.lock/` を自動作成
- **ロックファイル**: 操作開始時に `<repo>.lock` を作成
- **自動削除**: 操作完了時（成功・失敗問わず）に自動削除
- **タイムアウト処理**: 30秒以上古いロックファイルは自動削除される

---

## 5. パス解決ルール

### 5.1 相対パス・絶対パスの処理

#### 5.1.1 入力パスの正規化処理
**チルダ展開:**
- `~` で始まるパスはホームディレクトリに展開
- `~/ghwt` → `/Users/username/ghwt`

**相対パスの絶対パス化:**
- 相対パスは現在のディレクトリを基準に絶対パス化
- `./repo` → `/current/directory/repo`

**絶対パスの処理:**
- 絶対パスはそのまま使用

#### 5.1.2 シンボリックリンクの解決
- シンボリックリンクは実際のパスに解決
- 循環参照の検出と回避
- 存在しないリンク先の適切なエラー処理

### 5.2 パス表現の一貫性

#### 5.2.1 出力時のパス表現
| 用途 | 形式 | 例 |
|------|------|-----|
| **ユーザー表示** | チルダ短縮形 | `~/ghwt/myrepo/.wt/main` |
| **内部処理** | 絶対パス | `/Users/username/ghwt/myrepo/.wt/main` |
| **設定ファイル** | チルダ短縮形 | `~/ghwt` |
| **ログ出力** | 絶対パス | `/Users/username/ghwt/myrepo/.wt/main` |

#### 5.2.2 パス比較の正規化
- 両方のパスを正規化してから比較
- シンボリックリンクを解決してから比較
- 大文字小文字の扱いはファイルシステムに依存

---

## 6. ghq 互換性

### 6.1 ghq root の検出

#### 6.1.1 検出アルゴリズム
```
1. 環境変数 $GHQ_ROOT の確認
   → 設定されている場合はその値を使用

2. ghq コマンドの実行
   → ghq root コマンドで設定値を取得

3. デフォルト値の使用
   → ~/ghwt を使用
```

#### 6.1.2 ghq 設定ファイルの参照
```toml
# ~/.gitconfig または ~/.config/git/config
[ghq]
    root = ~/src
    root = ~/go/src
```

### 6.2 既存リポジトリの検出

#### 6.2.1 ghq 管理下リポジトリの発見
```bash
# ghq list で管理下のリポジトリを取得
ghq list | while read repo; do
    echo "$(ghq root)/$repo"
done
```

#### 6.2.2 GHWT への移行判定
```
1. ghq 管理下のリポジトリを検出
2. GHWT 形式への変換可能性を確認
3. ユーザーに移行オプションを提示
```

### 6.3 パス解決の優先順位

#### 6.3.1 リポジトリ検索順序
```
1. GHWT 管理下 (~/ghwt/<repo>/)
2. ghq 管理下 ($GHQ_ROOT/<host>/<user>/<repo>/)
3. 現在のディレクトリ
4. エラー: リポジトリが見つからない
```

#### 6.3.2 競合解決ルール
```
同名のリポジトリが複数存在する場合:
1. GHWT 管理下を優先
2. 複数候補がある場合はユーザーに選択を求める
3. --repo オプションで明示的に指定可能
```

---

## 7. エラー処理とクリーンアップ

### 7.1 不完全な状態の検出

#### 7.1.1 破損したレイアウトの識別
```
検証項目:
1. .bare ディレクトリの存在と有効性
2. .git ファイルの内容と参照先
3. .wt ディレクトリの構造
4. worktree の整合性
```

#### 7.1.2 診断アルゴリズム
**レイアウト状態の分類:**
- Valid: 正常な状態
- MissingBare: .bare ディレクトリが存在しない
- InvalidGitfile: .git ファイルが無効
- OrphanedWorktrees: 孤立した worktree が存在
- CorruptedRepository: リポジトリが破損

**診断手順:**
1. .bare ディレクトリの存在確認
2. .git ファイルの内容と参照先の検証
3. worktree の整合性確認
4. 状態に応じた診断結果の返却

### 7.2 自動修復機能

#### 7.2.1 `ghwt doctor` コマンド仕様
```bash
ghwt doctor [<repo>] [options]

オプション:
  --fix          自動修復を実行
  --dry-run      修復内容の確認のみ
  --verbose      詳細な診断情報を表示
```

#### 7.2.2 修復可能な問題と対処法
| 問題 | 自動修復 | 対処法 |
|------|----------|--------|
| 無効な gitfile | ✓ | 正しい内容で再作成 |
| 孤立した worktree | ✓ | git worktree prune で削除 |
| 不正な権限 | ✓ | 適切な権限に修正 |
| 破損した .bare | ✗ | 手動での再クローンが必要 |

### 7.3 手動クリーンアップ

#### 7.3.1 安全な削除手順
```bash
# 1. worktree の状態確認
cd ~/ghwt/<repo>
git worktree list

# 2. 未コミット変更の確認
for wt in .wt/*/; do
    echo "Checking $wt"
    cd "$wt" && git status --porcelain
done

# 3. 安全な削除実行
ghwt rm <repo> <branch>  # 個別削除
# または
rm -rf ~/ghwt/<repo>/    # リポジトリ全体削除
```

#### 7.3.2 緊急時の完全クリーンアップ
```bash
# 全 GHWT データの削除 (注意: 復元不可)
rm -rf ~/ghwt/

# 設定ファイルの削除
rm -rf ~/.config/ghwt/

# ロックファイルの削除
rm -rf ~/ghwt/.lock/
```

---

## 完了条件チェックリスト

- [x] Nick Nisi式アプローチの「1 Repository = 1 Directory」原則が実装されている
- [x] 完全なディレクトリ構造が定義されている（~/ghwt/<repo>/.bare/, .git, .wt/構造）
- [x] パス解決ルールが明確に定義されている
- [x] gitfile仕様が含まれている
- [x] 安全性機構が定義されている
- [x] ghq互換性が考慮されている
- [x] エラー処理が定義されている
- [x] 実装ガイドラインが含まれている

---

*本仕様書は GHWT プロジェクトのファイルシステムレイアウトの基盤仕様として、複数AIの並行開発を支援します。* 