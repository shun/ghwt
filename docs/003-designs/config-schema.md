# GHWT TOML設定ファイル完全スキーマ仕様書

**Version**: 1.0  
**Date**: 2025-06-01  
**Status**: Draft  

## 概要

本ドキュメントは GHWT プロジェクトの設定ファイル `config.toml` の完全スキーマ仕様書である。
XDG Base Directory Specification に準拠した設定ファイルの配置、全設定項目の詳細仕様、
バリデーションルール、設定の優先順位、および設定管理コマンドの仕様を定義する。

## 目的

- XDG Base Directory Specification準拠の設定ファイル仕様を定義
- 全設定項目のスキーマとバリデーションルールを明確化
- 設定の優先順位（環境変数 > 設定ファイル > デフォルト）を定義
- 設定管理の統一基盤を確立

---

## 1. 設定ファイル配置場所

### 1.1 XDG Base Directory Specification 準拠

GHWT は XDG Base Directory Specification に従って設定ファイルを配置する。

#### 設定ファイルパス決定ロジック

```
1. $XDG_CONFIG_HOME/ghwt/config.toml
2. ~/.config/ghwt/config.toml (XDG_CONFIG_HOME が未設定の場合)
```

#### 環境変数による上書き

| 環境変数 | 説明 | デフォルト |
|----------|------|-----------|
| `XDG_CONFIG_HOME` | XDG設定ディレクトリ | `~/.config` |
| `GHWT_CONFIG` | 設定ファイルパス（完全上書き） | - |

#### 設定ディレクトリ作成

設定ファイルが存在しない場合、GHWT は以下の動作を行う：

1. 設定ディレクトリが存在しない場合は自動作成
2. 設定ファイルは初回実行時に自動生成（デフォルト値で）
3. 権限は `0755`（ディレクトリ）、`0644`（ファイル）に設定

---

## 2. 完全なTOMLスキーマ定義

### 2.1 基本構造

```toml
# ~/.config/ghwt/config.toml
# GHWT Configuration File
# Generated by ghwt v1.0.0

[core]
root = "~/ghwt"
```

### 2.2 セクション別詳細仕様

#### 2.2.1 `[core]` セクション

| キー | 型 | デフォルト | 説明 | バリデーション |
|------|----|---------|----|---------------|
| `root` | string | `"~/ghwt"` | GHWT ルートディレクトリ | 有効なパス、書き込み権限必須 |

---

## 3. 設定の優先順位

GHWT は以下の優先順位で設定値を決定する：

### 3.1 優先順位（高 → 低）

1. **環境変数** (`GHWT_ROOT`)
2. **設定ファイル** (`config.toml`)
3. **デフォルト値** (`~/ghwt`)

### 3.2 環境変数マッピング

| 設定キー | 環境変数 | 例 |
|----------|----------|-----|
| `core.root` | `GHWT_ROOT` | `GHWT_ROOT=~/workspace` |

### 3.3 設定値解決例

```bash
# 設定ファイル
[core]
root = "~/ghwt"

# 環境変数で上書きする場合
export GHWT_ROOT="~/workspace"

# 実際の値: ~/workspace (環境変数が優先)
```

---

## 4. バリデーションルール

### 4.1 型バリデーション

| 型 | ルール | エラー例 |
|----|--------|----------|
| `string` | UTF-8文字列 | 無効なエンコーディング |
| `boolean` | `true`/`false` | `"yes"`, `1` は無効 |
| `integer` | 32bit符号付き整数 | `"abc"`, `3.14` は無効 |

### 4.2 値バリデーション

#### パス関連
```rust
// core.root のバリデーション
fn validate_root_path(path: &str) -> Result<(), ConfigError> {
    let expanded = expand_tilde(path)?;
    if !is_writable(&expanded) {
        return Err(ConfigError::PathNotWritable(path.to_string()));
    }
    Ok(())
}
```

### 4.3 エラーメッセージ

```
Error: Invalid configuration value
Key: core.root
Value: "/invalid/path"
Expected: Writable directory path
File: ~/.config/ghwt/config.toml:3
```

---

## 5. 設定管理コマンド仕様

### 5.1 `ghwt config set <key> <value>`

#### 例
```bash
# ルートディレクトリ変更
ghwt config set core.root ~/workspace
```

#### 出力
```
Configuration updated: core.root = ~/workspace
```

### 5.2 `ghwt config get <key>`

#### 例
```bash
# ルートディレクトリ取得
ghwt config get core.root
# 出力: ~/ghwt

# 存在しないキー
ghwt config get invalid.key
# 出力: Error: Configuration key not found: invalid.key
```

### 5.3 `ghwt config list [--json]`

#### 標準出力
```
core.root=~/ghwt
```

#### JSON出力 (`--json`)
```json
{
  "config": {
    "core": {
      "root": "~/ghwt"
    }
  },
  "sources": {
    "core.root": "default"
  }
}
```

### 5.4 `ghwt config unset <key>`

#### 例
```bash
ghwt config unset core.root
# 出力: Configuration key removed: core.root (reverted to default: ~/ghwt)
```

### 5.5 `ghwt config validate`

#### 例
```bash
ghwt config validate
# 出力: Configuration is valid

# エラーがある場合
ghwt config validate
# 出力:
# Error: Invalid configuration
# core.root: Path not writable: /invalid/path
```

---

## 6. 設定ファイル例

### 6.1 最小設定（デフォルト）
```toml
# ~/.config/ghwt/config.toml
[core]
root = "~/ghwt"
```

### 6.2 カスタム設定
```toml
# ~/.config/ghwt/config.toml
[core]
root = "~/workspace/ghwt"
```

---

## 7. 実装ガイドライン

### 7.1 Rust実装例

#### 設定構造体定義
```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Default, Deserialize, Serialize)]
pub struct Config {
    #[serde(default)]
    pub core: CoreConfig,
}

#[derive(Debug, Default, Deserialize, Serialize)]
pub struct CoreConfig {
    #[serde(default = "default_root")]
    pub root: String,
}

fn default_root() -> String {
    "~/ghwt".to_string()
}
```

#### 設定読み込み
```rust
use std::path::PathBuf;
use anyhow::Result;

pub fn load_config() -> Result<Config> {
    let config_path = get_config_path()?;
    
    if config_path.exists() {
        let content = std::fs::read_to_string(&config_path)?;
        let mut config: Config = toml::from_str(&content)?;
        
        // 環境変数で上書き
        override_with_env(&mut config)?;
        
        // バリデーション
        validate_config(&config)?;
        
        Ok(config)
    } else {
        // デフォルト設定を作成
        let config = Config::default();
        save_config(&config, &config_path)?;
        Ok(config)
    }
}

fn get_config_path() -> Result<PathBuf> {
    if let Ok(path) = std::env::var("GHWT_CONFIG") {
        return Ok(PathBuf::from(path));
    }
    
    let config_dir = if let Ok(xdg_config) = std::env::var("XDG_CONFIG_HOME") {
        PathBuf::from(xdg_config)
    } else {
        dirs::home_dir()
            .ok_or_else(|| anyhow::anyhow!("Cannot determine home directory"))?
            .join(".config")
    };
    
    Ok(config_dir.join("ghwt").join("config.toml"))
}

fn override_with_env(config: &mut Config) -> Result<()> {
    if let Ok(root) = std::env::var("GHWT_ROOT") {
        config.core.root = root;
    }
    Ok(())
}
```

### 7.2 バリデーション実装
```rust
use anyhow::{Result, anyhow};

pub fn validate_config(config: &Config) -> Result<()> {
    validate_core_config(&config.core)?;
    Ok(())
}

fn validate_core_config(core: &CoreConfig) -> Result<()> {
    // root パスの検証
    let expanded_root = expand_tilde(&core.root)?;
    if !is_writable(&expanded_root) {
        return Err(anyhow!("Root directory is not writable: {}", core.root));
    }
    
    Ok(())
}

fn expand_tilde(path: &str) -> Result<PathBuf> {
    if path.starts_with("~/") {
        let home = dirs::home_dir()
            .ok_or_else(|| anyhow!("Cannot determine home directory"))?;
        Ok(home.join(&path[2..]))
    } else {
        Ok(PathBuf::from(path))
    }
}

fn is_writable(path: &PathBuf) -> bool {
    // パスが存在する場合は書き込み権限をチェック
    if path.exists() {
        return path.metadata().map(|m| !m.permissions().readonly()).unwrap_or(false);
    }
    
    // パスが存在しない場合は親ディレクトリの書き込み権限をチェック
    if let Some(parent) = path.parent() {
        parent.exists() && is_writable(&parent.to_path_buf())
    } else {
        false
    }
}
```

---

## 8. 完了条件チェックリスト

- [x] `docs/003-designs/config-schema.md` ファイルが作成されている
- [x] 完全なTOMLスキーマが定義されている
- [x] 全設定項目のバリデーションルールが明記されている
- [x] 設定の優先順位が明確に定義されている
- [x] 設定管理コマンドの仕様が含まれている
- [x] XDG Base Directory Specification準拠の配置場所が定義されている
- [x] 環境変数による上書き仕様が含まれている
- [x] 実装ガイドラインが含まれている

---

## 9. 関連ドキュメント

- [ADR-006: TOML設定ファイルとXDG Base Directory Specificationの採用](../004-adr/006-toml-config.md)
- [CLI インターフェース完全仕様書](./cli-interface.md)
- [要件定義書](../002-requirements/requirements-ja.md)

---

*本仕様書は GHWT プロジェクトの設定管理基盤として、統一された設定体験を提供します。*